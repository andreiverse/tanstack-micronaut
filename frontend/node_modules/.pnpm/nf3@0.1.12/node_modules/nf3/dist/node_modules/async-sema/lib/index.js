"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,`__esModule`,{value:!0}),exports.RateLimit=exports.Sema=void 0;const events_1=__importDefault(require(`events`));function arrayMove(e,o,s,c,l){for(let u=0;u<l;++u)s[u+c]=e[u+o],e[u+o]=void 0}function pow2AtLeast(e){return e>>>=0,--e,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,e+1}function getCapacity(e){return pow2AtLeast(Math.min(Math.max(16,e),1073741824))}class Deque{constructor(e){this._capacity=getCapacity(e),this._length=0,this._front=0,this.arr=[]}push(e){let o=this._length;this.checkCapacity(o+1);let s=this._front+o&this._capacity-1;return this.arr[s]=e,this._length=o+1,o+1}pop(){let e=this._length;if(e===0)return;let o=this._front+e-1&this._capacity-1,s=this.arr[o];return this.arr[o]=void 0,this._length=e-1,s}shift(){let e=this._length;if(e===0)return;let o=this._front,s=this.arr[o];return this.arr[o]=void 0,this._front=o+1&this._capacity-1,this._length=e-1,s}get length(){return this._length}checkCapacity(e){this._capacity<e&&this.resizeTo(getCapacity(this._capacity*1.5+16))}resizeTo(e){let o=this._capacity;this._capacity=e;let c=this._front,l=this._length;if(c+l>o){let e=c+l&o-1;arrayMove(this.arr,0,this.arr,o,e)}}}class ReleaseEmitter extends events_1.default{}function isFn(e){return typeof e==`function`}function defaultInit(){return`1`}class Sema{constructor(e,{initFn:o=defaultInit,pauseFn:s,resumeFn:c,capacity:l=10}={}){if(isFn(s)!==isFn(c))throw Error(`pauseFn and resumeFn must be both set for pausing`);this.nrTokens=e,this.free=new Deque(e),this.waiting=new Deque(l),this.releaseEmitter=new ReleaseEmitter,this.noTokens=o===defaultInit,this.pauseFn=s,this.resumeFn=c,this.paused=!1,this.releaseEmitter.on(`release`,e=>{let o=this.waiting.shift();o?o.resolve(e):(this.resumeFn&&this.paused&&(this.paused=!1,this.resumeFn()),this.free.push(e))});for(let s=0;s<e;s++)this.free.push(o())}tryAcquire(){return this.free.pop()}async acquire(){let e=this.tryAcquire();return e===void 0?new Promise((e,o)=>{this.pauseFn&&!this.paused&&(this.paused=!0,this.pauseFn()),this.waiting.push({resolve:e,reject:o})}):e}release(e){this.releaseEmitter.emit(`release`,this.noTokens?`1`:e)}drain(){let e=Array(this.nrTokens);for(let o=0;o<this.nrTokens;o++)e[o]=this.acquire();return Promise.all(e)}nrWaiting(){return this.waiting.length}}exports.Sema=Sema;function RateLimit(e,{timeUnit:o=1e3,uniformDistribution:s=!1}={}){let c=new Sema(s?1:e),l=s?o/e:o;return async function(){await c.acquire(),setTimeout(()=>c.release(),l)}}exports.RateLimit=RateLimit;