"use strict";const utils=require(`./utils`),{CHAR_ASTERISK,CHAR_AT,CHAR_BACKWARD_SLASH,CHAR_COMMA,CHAR_DOT,CHAR_EXCLAMATION_MARK,CHAR_FORWARD_SLASH,CHAR_LEFT_CURLY_BRACE,CHAR_LEFT_PARENTHESES,CHAR_LEFT_SQUARE_BRACKET,CHAR_PLUS,CHAR_QUESTION_MARK,CHAR_RIGHT_CURLY_BRACE,CHAR_RIGHT_PARENTHESES,CHAR_RIGHT_SQUARE_BRACKET}=require(`./constants`),isPathSeparator=t=>t===CHAR_FORWARD_SLASH||t===CHAR_BACKWARD_SLASH,depth=t=>{t.isPrefix!==!0&&(t.depth=t.isGlobstar?1/0:1)},scan=(v,y)=>{let b=y||{},x=v.length-1,S=b.parts===!0||b.scanToEnd===!0,C=[],w=[],T=[],E=v,D=-1,O=0,k=0,A=!1,j=!1,M=!1,N=!1,P=!1,F=!1,I=!1,L=!1,R=!1,z=!1,B=0,V,H,U={value:``,depth:0,isGlob:!1},W=()=>D>=x,G=()=>E.charCodeAt(D+1),K=()=>(V=H,E.charCodeAt(++D));for(;D<x;){H=K();let t;if(H===CHAR_BACKWARD_SLASH){I=U.backslashes=!0,H=K(),H===CHAR_LEFT_CURLY_BRACE&&(F=!0);continue}if(F===!0||H===CHAR_LEFT_CURLY_BRACE){for(B++;W()!==!0&&(H=K());){if(H===CHAR_BACKWARD_SLASH){I=U.backslashes=!0,K();continue}if(H===CHAR_LEFT_CURLY_BRACE){B++;continue}if(F!==!0&&H===CHAR_DOT&&(H=K())===CHAR_DOT){if(A=U.isBrace=!0,M=U.isGlob=!0,z=!0,S===!0)continue;break}if(F!==!0&&H===CHAR_COMMA){if(A=U.isBrace=!0,M=U.isGlob=!0,z=!0,S===!0)continue;break}if(H===CHAR_RIGHT_CURLY_BRACE&&(B--,B===0)){F=!1,A=U.isBrace=!0,z=!0;break}}if(S===!0)continue;break}if(H===CHAR_FORWARD_SLASH){if(C.push(D),w.push(U),U={value:``,depth:0,isGlob:!1},z===!0)continue;if(V===CHAR_DOT&&D===O+1){O+=2;continue}k=D+1;continue}if(b.noext!==!0&&(H===CHAR_PLUS||H===CHAR_AT||H===CHAR_ASTERISK||H===CHAR_QUESTION_MARK||H===CHAR_EXCLAMATION_MARK)&&G()===CHAR_LEFT_PARENTHESES){if(M=U.isGlob=!0,N=U.isExtglob=!0,z=!0,H===CHAR_EXCLAMATION_MARK&&D===O&&(R=!0),S===!0){for(;W()!==!0&&(H=K());){if(H===CHAR_BACKWARD_SLASH){I=U.backslashes=!0,H=K();continue}if(H===CHAR_RIGHT_PARENTHESES){M=U.isGlob=!0,z=!0;break}}continue}break}if(H===CHAR_ASTERISK){if(V===CHAR_ASTERISK&&(P=U.isGlobstar=!0),M=U.isGlob=!0,z=!0,S===!0)continue;break}if(H===CHAR_QUESTION_MARK){if(M=U.isGlob=!0,z=!0,S===!0)continue;break}if(H===CHAR_LEFT_SQUARE_BRACKET){for(;W()!==!0&&(t=K());){if(t===CHAR_BACKWARD_SLASH){I=U.backslashes=!0,K();continue}if(t===CHAR_RIGHT_SQUARE_BRACKET){j=U.isBracket=!0,M=U.isGlob=!0,z=!0;break}}if(S===!0)continue;break}if(b.nonegate!==!0&&H===CHAR_EXCLAMATION_MARK&&D===O){L=U.negated=!0,O++;continue}if(b.noparen!==!0&&H===CHAR_LEFT_PARENTHESES){if(M=U.isGlob=!0,S===!0){for(;W()!==!0&&(H=K());){if(H===CHAR_LEFT_PARENTHESES){I=U.backslashes=!0,H=K();continue}if(H===CHAR_RIGHT_PARENTHESES){z=!0;break}}continue}break}if(M===!0){if(z=!0,S===!0)continue;break}}b.noext===!0&&(N=!1,M=!1);let q=E,J=``,Y=``;O>0&&(J=E.slice(0,O),E=E.slice(O),k-=O),q&&M===!0&&k>0?(q=E.slice(0,k),Y=E.slice(k)):M===!0?(q=``,Y=E):q=E,q&&q!==``&&q!==`/`&&q!==E&&isPathSeparator(q.charCodeAt(q.length-1))&&(q=q.slice(0,-1)),b.unescape===!0&&(Y&&=utils.removeBackslashes(Y),q&&I===!0&&(q=utils.removeBackslashes(q)));let X={prefix:J,input:v,start:O,base:q,glob:Y,isBrace:A,isBracket:j,isGlob:M,isExtglob:N,isGlobstar:P,negated:L,negatedExtglob:R};if(b.tokens===!0&&(X.maxDepth=0,isPathSeparator(H)||w.push(U),X.tokens=w),b.parts===!0||b.tokens===!0){let t;for(let m=0;m<C.length;m++){let h=t?t+1:O,g=C[m],_=v.slice(h,g);b.tokens&&(m===0&&O!==0?(w[m].isPrefix=!0,w[m].value=J):w[m].value=_,depth(w[m]),X.maxDepth+=w[m].depth),(m!==0||_!==``)&&T.push(_),t=g}if(t&&t+1<v.length){let m=v.slice(t+1);T.push(m),b.tokens&&(w[w.length-1].value=m,depth(w[w.length-1]),X.maxDepth+=w[w.length-1].depth)}X.slashes=C,X.parts=T}return X};module.exports=scan;