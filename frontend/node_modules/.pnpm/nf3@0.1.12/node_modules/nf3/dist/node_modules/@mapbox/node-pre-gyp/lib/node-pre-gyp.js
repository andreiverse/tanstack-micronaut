"use strict";module.exports=exports,exports.mockS3Http=require(`./util/s3_setup`).get_mockS3Http(),exports.mockS3Http(`on`);const mocking=exports.mockS3Http(`get`),fs=require(`fs`),path=require(`path`),nopt=require(`nopt`),log=require(`./util/log.js`),napi=require(`./util/napi.js`),EE=require(`events`).EventEmitter,inherits=require(`util`).inherits,cli_commands=[`clean`,`install`,`reinstall`,`build`,`rebuild`,`package`,`testpackage`,`publish`,`unpublish`,`info`,`testbinary`,`reveal`,`configure`],aliases={};mocking&&log.warn(`mocking s3 to ${process.env.node_pre_gyp_mock_s3}`),Object.defineProperty(exports,`find`,{get:function(){return require(`./pre-binding`).find},enumerable:!0});function Run({package_json_path:e=`./package.json`,argv:o}){this.package_json_path=e,this.commands={};let s=this;cli_commands.forEach(e=>{s.commands[e]=function(o,c){return log.verbose(`command`,e,o),require(`./`+e)(s,o,c)}}),this.parseArgv(o),this.binaryHostSet=!1}inherits(Run,EE),exports.Run=Run;const proto=Run.prototype;proto.package=require(`../package.json`),proto.configDefs={help:Boolean,arch:String,debug:Boolean,directory:String,proxy:String,loglevel:String},proto.shorthands={release:`--no-debug`,C:`--directory`,debug:`--debug`,j:`--jobs`,silent:`--loglevel=silent`,silly:`--loglevel=silly`,verbose:`--loglevel=verbose`},proto.aliases=aliases,proto.parseArgv=function(e){this.opts=nopt(this.configDefs,this.shorthands,e),this.argv=this.opts.argv.remain.slice();let l=this.todo=[];e=this.argv.map(e=>(e in this.aliases&&(e=this.aliases[e]),e)),e.slice().forEach(o=>{if(o in this.commands){let s=e.splice(0,e.indexOf(o));e.shift(),l.length>0&&(l[l.length-1].args=s),l.push({name:o,args:[]})}}),l.length>0&&(l[l.length-1].args=e.splice(0));let u=this.package_json_path;this.opts.directory&&(u=path.join(this.opts.directory,u)),this.package_json=JSON.parse(fs.readFileSync(u)),this.todo=napi.expand_commands(this.package_json,this.opts,l);let d=`npm_config_`;Object.keys(process.env).forEach(e=>{if(e.indexOf(d)!==0)return;let o=process.env[e];e===d+`loglevel`?log.level=o:(e=e.substring(11),e===`argv`&&this.opts.argv&&this.opts.argv.remain&&this.opts.argv.remain.length||(this.opts[e]=o))}),this.opts.loglevel&&(log.level=this.opts.loglevel),log.resume()},proto.setBinaryHostProperty=function(e){if(this.binaryHostSet)return this.package_json.binary.host;let o=this.package_json;if(!o||!o.binary||o.binary.host||!o.binary.staging_host||!o.binary.production_host)return``;let s=`production_host`;(e===`publish`||e===`unpublish`)&&(s=`staging_host`);let c=process.env.node_pre_gyp_s3_host;if(c===`staging`||c===`production`)s=`${c}_host`;else if(this.opts.s3_host===`staging`||this.opts.s3_host===`production`)s=`${this.opts.s3_host}_host`;else if(this.opts.s3_host||c)throw Error(`invalid s3_host ${this.opts.s3_host||c}`);return o.binary.host=o.binary[s],this.binaryHostSet=!0,o.binary.host},proto.usage=function(){return[``,`  Usage: node-pre-gyp <command> [options]`,``,`  where <command> is one of:`,cli_commands.map(e=>`    - `+e+` - `+require(`./`+e).usage).join(`
`),``,`node-pre-gyp@`+this.version+`  `+path.resolve(__dirname,`..`),`node@`+process.versions.node].join(`
`)},Object.defineProperty(proto,`version`,{get:function(){return this.package.version},enumerable:!0});