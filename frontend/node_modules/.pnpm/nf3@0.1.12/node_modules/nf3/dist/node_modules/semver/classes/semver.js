"use strict";const debug=require(`../internal/debug`),{MAX_LENGTH,MAX_SAFE_INTEGER}=require(`../internal/constants`),{safeRe:re,t}=require(`../internal/re`),parseOptions=require(`../internal/parse-options`),{compareIdentifiers}=require(`../internal/identifiers`);class SemVer{constructor(c,l){if(l=parseOptions(l),c instanceof SemVer){if(c.loose===!!l.loose&&c.includePrerelease===!!l.includePrerelease)return c;c=c.version}else if(typeof c!=`string`)throw TypeError(`Invalid version. Must be a string. Got type "${typeof c}".`);if(c.length>MAX_LENGTH)throw TypeError(`version is longer than ${MAX_LENGTH} characters`);debug(`SemVer`,c,l),this.options=l,this.loose=!!l.loose,this.includePrerelease=!!l.includePrerelease;let u=c.trim().match(l.loose?re[t.LOOSE]:re[t.FULL]);if(!u)throw TypeError(`Invalid Version: ${c}`);if(this.raw=c,this.major=+u[1],this.minor=+u[2],this.patch=+u[3],this.major>MAX_SAFE_INTEGER||this.major<0)throw TypeError(`Invalid major version`);if(this.minor>MAX_SAFE_INTEGER||this.minor<0)throw TypeError(`Invalid minor version`);if(this.patch>MAX_SAFE_INTEGER||this.patch<0)throw TypeError(`Invalid patch version`);u[4]?this.prerelease=u[4].split(`.`).map(e=>{if(/^[0-9]+$/.test(e)){let i=+e;if(i>=0&&i<MAX_SAFE_INTEGER)return i}return e}):this.prerelease=[],this.build=u[5]?u[5].split(`.`):[],this.format()}format(){return this.version=`${this.major}.${this.minor}.${this.patch}`,this.prerelease.length&&(this.version+=`-${this.prerelease.join(`.`)}`),this.version}toString(){return this.version}compare(i){if(debug(`SemVer.compare`,this.version,this.options,i),!(i instanceof SemVer)){if(typeof i==`string`&&i===this.version)return 0;i=new SemVer(i,this.options)}return i.version===this.version?0:this.compareMain(i)||this.comparePre(i)}compareMain(e){return e instanceof SemVer||(e=new SemVer(e,this.options)),this.major<e.major?-1:this.major>e.major?1:this.minor<e.minor?-1:this.minor>e.minor?1:this.patch<e.patch?-1:this.patch>e.patch?1:0}comparePre(i){if(i instanceof SemVer||(i=new SemVer(i,this.options)),this.prerelease.length&&!i.prerelease.length)return-1;if(!this.prerelease.length&&i.prerelease.length)return 1;if(!this.prerelease.length&&!i.prerelease.length)return 0;let a=0;do{let o=this.prerelease[a],s=i.prerelease[a];if(debug(`prerelease compare`,a,o,s),o===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(o===void 0)return-1;if(o===s)continue;return compareIdentifiers(o,s)}while(++a)}compareBuild(i){i instanceof SemVer||(i=new SemVer(i,this.options));let a=0;do{let o=this.build[a],s=i.build[a];if(debug(`build compare`,a,o,s),o===void 0&&s===void 0)return 0;if(s===void 0)return 1;if(o===void 0)return-1;if(o===s)continue;return compareIdentifiers(o,s)}while(++a)}inc(e,i,a){if(e.startsWith(`pre`)){if(!i&&a===!1)throw Error(`invalid increment argument: identifier is empty`);if(i){let e=`-${i}`.match(this.options.loose?re[t.PRERELEASELOOSE]:re[t.PRERELEASE]);if(!e||e[1]!==i)throw Error(`invalid identifier: ${i}`)}}switch(e){case`premajor`:this.prerelease.length=0,this.patch=0,this.minor=0,this.major++,this.inc(`pre`,i,a);break;case`preminor`:this.prerelease.length=0,this.patch=0,this.minor++,this.inc(`pre`,i,a);break;case`prepatch`:this.prerelease.length=0,this.inc(`patch`,i,a),this.inc(`pre`,i,a);break;case`prerelease`:this.prerelease.length===0&&this.inc(`patch`,i,a),this.inc(`pre`,i,a);break;case`release`:if(this.prerelease.length===0)throw Error(`version ${this.raw} is not a prerelease`);this.prerelease.length=0;break;case`major`:(this.minor!==0||this.patch!==0||this.prerelease.length===0)&&this.major++,this.minor=0,this.patch=0,this.prerelease=[];break;case`minor`:(this.patch!==0||this.prerelease.length===0)&&this.minor++,this.patch=0,this.prerelease=[];break;case`patch`:this.prerelease.length===0&&this.patch++,this.prerelease=[];break;case`pre`:{let e=Number(a)?1:0;if(this.prerelease.length===0)this.prerelease=[e];else{let o=this.prerelease.length;for(;--o>=0;)typeof this.prerelease[o]==`number`&&(this.prerelease[o]++,o=-2);if(o===-1){if(i===this.prerelease.join(`.`)&&a===!1)throw Error(`invalid increment argument: identifier already exists`);this.prerelease.push(e)}}if(i){let o=[i,e];a===!1&&(o=[i]),compareIdentifiers(this.prerelease[0],i)===0?isNaN(this.prerelease[1])&&(this.prerelease=o):this.prerelease=o}break}default:throw Error(`invalid increment argument: ${e}`)}return this.raw=this.format(),this.build.length&&(this.raw+=`+${this.build.join(`.`)}`),this}}module.exports=SemVer;