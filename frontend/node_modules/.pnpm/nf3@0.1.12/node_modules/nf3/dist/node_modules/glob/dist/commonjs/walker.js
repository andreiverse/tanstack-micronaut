"use strict";Object.defineProperty(exports,`__esModule`,{value:!0}),exports.GlobStream=exports.GlobWalker=exports.GlobUtil=void 0;const minipass_1=require(`minipass`),ignore_js_1=require(`./ignore.js`),processor_js_1=require(`./processor.js`),makeIgnore=(e,r)=>typeof e==`string`?new ignore_js_1.Ignore([e],r):Array.isArray(e)?new ignore_js_1.Ignore(e,r):e;class GlobUtil{path;patterns;opts;seen=new Set;paused=!1;aborted=!1;#onResume=[];#ignore;#sep;signal;maxDepth;includeChildMatches;constructor(e,n,r){if(this.patterns=e,this.path=n,this.opts=r,this.#sep=!r.posix&&r.platform===`win32`?`\\`:`/`,this.includeChildMatches=r.includeChildMatches!==!1,(r.ignore||!this.includeChildMatches)&&(this.#ignore=makeIgnore(r.ignore??[],r),!this.includeChildMatches&&typeof this.#ignore.add!=`function`))throw Error(`cannot ignore child matches, ignore lacks add() method.`);this.maxDepth=r.maxDepth||1/0,r.signal&&(this.signal=r.signal,this.signal.addEventListener(`abort`,()=>{this.#onResume.length=0}))}#ignored(e){return this.seen.has(e)||!!this.#ignore?.ignored?.(e)}#childrenIgnored(e){return!!this.#ignore?.childrenIgnored?.(e)}pause(){this.paused=!0}resume(){if(this.signal?.aborted)return;this.paused=!1;let e;for(;!this.paused&&(e=this.#onResume.shift());)e()}onResume(e){this.signal?.aborted||(this.paused?this.#onResume.push(e):e())}async matchCheck(e,n){if(n&&this.opts.nodir)return;let r;if(this.opts.realpath){if(r=e.realpathCached()||await e.realpath(),!r)return;e=r}let i=e.isUnknown()||this.opts.stat?await e.lstat():e;if(this.opts.follow&&this.opts.nodir&&i?.isSymbolicLink()){let e=await i.realpath();e&&(e.isUnknown()||this.opts.stat)&&await e.lstat()}return this.matchCheckTest(i,n)}matchCheckTest(e,n){return e&&(this.maxDepth===1/0||e.depth()<=this.maxDepth)&&(!n||e.canReaddir())&&(!this.opts.nodir||!e.isDirectory())&&(!this.opts.nodir||!this.opts.follow||!e.isSymbolicLink()||!e.realpathCached()?.isDirectory())&&!this.#ignored(e)?e:void 0}matchCheckSync(e,n){if(n&&this.opts.nodir)return;let r;if(this.opts.realpath){if(r=e.realpathCached()||e.realpathSync(),!r)return;e=r}let i=e.isUnknown()||this.opts.stat?e.lstatSync():e;if(this.opts.follow&&this.opts.nodir&&i?.isSymbolicLink()){let e=i.realpathSync();e&&(e?.isUnknown()||this.opts.stat)&&e.lstatSync()}return this.matchCheckTest(i,n)}matchFinish(e,n){if(this.#ignored(e))return;if(!this.includeChildMatches&&this.#ignore?.add){let n=`${e.relativePosix()}/**`;this.#ignore.add(n)}let r=this.opts.absolute===void 0?n:this.opts.absolute;this.seen.add(e);let i=this.opts.mark&&e.isDirectory()?this.#sep:``;if(this.opts.withFileTypes)this.matchEmit(e);else if(r){let n=this.opts.posix?e.fullpathPosix():e.fullpath();this.matchEmit(n+i)}else{let n=this.opts.posix?e.relativePosix():e.relative(),r=this.opts.dotRelative&&!n.startsWith(`..`+this.#sep)?`.`+this.#sep:``;this.matchEmit(n?r+n+i:`.`+i)}}async match(e,n,r){let i=await this.matchCheck(e,r);i&&this.matchFinish(i,n)}matchSync(e,n,r){let i=this.matchCheckSync(e,r);i&&this.matchFinish(i,n)}walkCB(e,n,i){this.signal?.aborted&&i(),this.walkCB2(e,n,new processor_js_1.Processor(this.opts),i)}walkCB2(e,n,r,i){if(this.#childrenIgnored(e))return i();if(this.signal?.aborted&&i(),this.paused){this.onResume(()=>this.walkCB2(e,n,r,i));return}r.processPatterns(e,n);let a=1,o=()=>{--a===0&&i()};for(let[e,n,i]of r.matches.entries())this.#ignored(e)||(a++,this.match(e,n,i).then(()=>o()));for(let e of r.subwalkTargets()){if(this.maxDepth!==1/0&&e.depth()>=this.maxDepth)continue;a++;let n=e.readdirCached();e.calledReaddir()?this.walkCB3(e,n,r,o):e.readdirCB((n,i)=>this.walkCB3(e,i,r,o),!0)}o()}walkCB3(e,n,r,i){r=r.filterEntries(e,n);let a=1,o=()=>{--a===0&&i()};for(let[e,n,i]of r.matches.entries())this.#ignored(e)||(a++,this.match(e,n,i).then(()=>o()));for(let[e,n]of r.subwalks.entries())a++,this.walkCB2(e,n,r.child(),o);o()}walkCBSync(e,n,i){this.signal?.aborted&&i(),this.walkCB2Sync(e,n,new processor_js_1.Processor(this.opts),i)}walkCB2Sync(e,n,r,i){if(this.#childrenIgnored(e))return i();if(this.signal?.aborted&&i(),this.paused){this.onResume(()=>this.walkCB2Sync(e,n,r,i));return}r.processPatterns(e,n);let a=1,o=()=>{--a===0&&i()};for(let[e,n,i]of r.matches.entries())this.#ignored(e)||this.matchSync(e,n,i);for(let e of r.subwalkTargets()){if(this.maxDepth!==1/0&&e.depth()>=this.maxDepth)continue;a++;let n=e.readdirSync();this.walkCB3Sync(e,n,r,o)}o()}walkCB3Sync(e,n,r,i){r=r.filterEntries(e,n);let a=1,o=()=>{--a===0&&i()};for(let[e,n,i]of r.matches.entries())this.#ignored(e)||this.matchSync(e,n,i);for(let[e,n]of r.subwalks.entries())a++,this.walkCB2Sync(e,n,r.child(),o);o()}}exports.GlobUtil=GlobUtil;class GlobWalker extends GlobUtil{matches=new Set;constructor(e,n,r){super(e,n,r)}matchEmit(e){this.matches.add(e)}async walk(){if(this.signal?.aborted)throw this.signal.reason;return this.path.isUnknown()&&await this.path.lstat(),await new Promise((e,n)=>{this.walkCB(this.path,this.patterns,()=>{this.signal?.aborted?n(this.signal.reason):e(this.matches)})}),this.matches}walkSync(){if(this.signal?.aborted)throw this.signal.reason;return this.path.isUnknown()&&this.path.lstatSync(),this.walkCBSync(this.path,this.patterns,()=>{if(this.signal?.aborted)throw this.signal.reason}),this.matches}}exports.GlobWalker=GlobWalker;class GlobStream extends GlobUtil{results;constructor(n,r,i){super(n,r,i),this.results=new minipass_1.Minipass({signal:this.signal,objectMode:!0}),this.results.on(`drain`,()=>this.resume()),this.results.on(`resume`,()=>this.resume())}matchEmit(e){this.results.write(e),this.results.flowing||this.pause()}stream(){let e=this.path;return e.isUnknown()?e.lstat().then(()=>{this.walkCB(e,this.patterns,()=>this.results.end())}):this.walkCB(e,this.patterns,()=>this.results.end()),this.results}streamSync(){return this.path.isUnknown()&&this.path.lstatSync(),this.walkCBSync(this.path,this.patterns,()=>this.results.end()),this.results}}exports.GlobStream=GlobStream;