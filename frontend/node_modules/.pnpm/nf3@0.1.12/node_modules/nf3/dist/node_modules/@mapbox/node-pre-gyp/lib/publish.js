"use strict";module.exports=exports=publish,exports.usage=`Publishes pre-built binary (requires aws-sdk)`;const fs=require(`fs`),path=require(`path`),log=require(`./util/log.js`),versioning=require(`./util/versioning.js`),napi=require(`./util/napi.js`),s3_setup=require(`./util/s3_setup.js`),existsAsync=fs.exists||path.exists,url=require(`url`);function publish(r,c,l){let u=r.package_json,d=napi.get_napi_build_version_from_command_args(c),f=versioning.evaluate(u,r.opts,d),p=f.staged_tarball;existsAsync(p,r=>{if(!r)return l(Error(`Cannot publish because `+p+" missing: run `node-pre-gyp package` first"));log.info(`publish`,`Detecting s3 credentials`);let i=s3_setup.detect(f),a=s3_setup.get_s3(i),s=url.resolve(i.prefix,f.package_name),c={Bucket:i.bucket,Key:s};log.info(`publish`,`Authenticating with s3`),log.info(`publish`,i),log.info(`publish`,`Checking for existing binary at `+f.hosted_path),a.headObject(c,(r,o)=>{if(o&&log.info(`publish`,JSON.stringify(o)),r&&r.code===`NotFound`){log.info(`publish`,`Preparing to put object`);let r={ACL:`public-read`,Body:fs.createReadStream(p),Key:s,Bucket:i.bucket};log.info(`publish`,`Putting object`,r.ACL,r.Bucket,r.Key);try{a.putObject(r,(e,r)=>(log.info(`publish`,`returned from putting object`),e?(log.info(`publish`,`s3 putObject error: "`+e+`"`),l(e)):(r&&log.info(`publish`,`s3 putObject response: "`+JSON.stringify(r)+`"`),log.info(`publish`,`successfully put object`),console.log(`[`+u.name+`] Success: published to `+f.hosted_path),l())))}catch(e){return log.info(`publish`,`s3 putObject error: "`+e+`"`),l(e)}}else if(r)return log.info(`publish`,`s3 headObject error: "`+r+`"`),l(r);else return log.error(`publish`,`Cannot publish over existing version`),log.error(`publish`,`Update the 'version' field in package.json and try again`),log.error(`publish`,`If the previous version was published in error see:`),log.error(`publish`,`	 node-pre-gyp unpublish`),l(Error(`Failed publishing to `+f.hosted_path))})})}