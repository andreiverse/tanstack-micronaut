"use strict";module.exports=exports=testpackage,exports.usage=`Tests that the staged package is valid`;const fs=require(`fs`),path=require(`path`),log=require(`./util/log.js`),existsAsync=fs.exists||path.exists,versioning=require(`./util/versioning.js`),napi=require(`./util/napi.js`),testbinary=require(`./testbinary.js`),tar=require(`tar`);function testpackage(i,c,l){let u=i.package_json,d=napi.get_napi_build_version_from_command_args(c),f=versioning.evaluate(u,i.opts,d),p=f.staged_tarball;existsAsync(p,a=>{if(!a)return l(Error(`Cannot test package because `+p+" missing: run `node-pre-gyp package` first"));let o=f.module_path;function s(e){log.info(`install`,`unpacking [`+e.path+`]`)}fs.promises.mkdir(o,{recursive:!0}).then(()=>{tar.extract({file:p,cwd:o,strip:1,onentry:s}).then(d,l)}).catch(e=>l(e));function d(){testbinary(i,c,e=>e?l(e):(console.log(`[`+u.name+`] Package appears valid`),l()))}})}