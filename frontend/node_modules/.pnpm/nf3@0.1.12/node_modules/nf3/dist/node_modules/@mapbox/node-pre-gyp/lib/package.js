"use strict";module.exports=exports=_package,exports.usage=`Packs binary (and enclosing directory) into locally staged tarball`;const fs=require(`fs`),path=require(`path`),log=require(`./util/log.js`),versioning=require(`./util/versioning.js`),napi=require(`./util/napi.js`),existsAsync=fs.exists||path.exists,tar=require(`tar`);function readdirSync(i){let a=[];return fs.readdirSync(i).forEach(o=>{fs.lstatSync(path.join(i,o)).isDirectory()?a=a.concat(readdirSync(path.join(i,o))):a.push(path.join(i,o))}),a}function _package(c,l,u){let d=c.package_json,f=napi.get_napi_build_version_from_command_args(l),p=versioning.evaluate(d,c.opts,f),m=p.module_path,h=path.join(m,p.module_name+`.node`);existsAsync(h,a=>{if(!a)return u(Error(`Cannot package because `+h+" missing: run `node-pre-gyp rebuild` first"));let o=p.staged_tarball,s=function(e){let i=path.basename(e);return i.length&&i[0]!==`.`?(console.log(`packing `+e),!0):(console.log(`skipping `+e),!1)};fs.promises.mkdir(path.dirname(o),{recursive:!0}).then(()=>{let e=readdirSync(m),a=path.basename(m);e=e.map(e=>path.join(a,path.relative(m,e))),tar.create({portable:!1,gzip:!0,filter:s,file:o,cwd:path.dirname(m)},e,e=>(e?console.error(`[`+d.name+`] `+e.message):log.info(`package`,`Binary staged at "`+o+`"`),u(e)))}).catch(e=>u(e))})}