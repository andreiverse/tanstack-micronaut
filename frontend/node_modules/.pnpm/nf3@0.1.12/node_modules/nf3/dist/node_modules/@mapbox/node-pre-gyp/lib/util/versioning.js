"use strict";module.exports=exports;const path=require(`path`),semver=require(`semver`),url=require(`url`),detect_libc=require(`detect-libc`),napi=require(`./napi.js`);let abi_crosswalk;abi_crosswalk=process.env.NODE_PRE_GYP_ABI_CROSSWALK?require(process.env.NODE_PRE_GYP_ABI_CROSSWALK):require(`./abi_crosswalk.json`);const major_versions={};Object.keys(abi_crosswalk).forEach(e=>{let s=e.split(`.`)[0];major_versions[s]||(major_versions[s]=e)});function get_electron_abi(e,c){if(!e)throw Error(`get_electron_abi requires valid runtime arg`);if(c===void 0)throw Error(`Empty target version is not supported if electron is the target.`);let l=semver.parse(c);return e+`-v`+l.major+`.`+l.minor}module.exports.get_electron_abi=get_electron_abi;function get_node_webkit_abi(e,s){if(!e)throw Error(`get_node_webkit_abi requires valid runtime arg`);if(s===void 0)throw Error(`Empty target version is not supported if node-webkit is the target.`);return e+`-v`+s}module.exports.get_node_webkit_abi=get_node_webkit_abi;function get_node_abi(e,c){if(!e)throw Error(`get_node_abi requires valid runtime arg`);if(!c)throw Error(`get_node_abi requires valid process.versions object`);let l=semver.parse(c.node);return l.major===0&&l.minor%2?e+`-v`+c.node:c.modules?e+`-v`+ +c.modules:`v8-`+c.v8.split(`.`).slice(0,2).join(`.`)}module.exports.get_node_abi=get_node_abi;function get_runtime_abi(e,s){if(!e)throw Error(`get_runtime_abi requires valid runtime arg`);if(e===`node-webkit`)return get_node_webkit_abi(e,s||process.versions[`node-webkit`]);if(e===`electron`)return get_electron_abi(e,s||process.versions.electron);if(e!==`node`)throw Error(`Unknown Runtime: '`+e+`'`);if(s){let c;if(abi_crosswalk[s])c=abi_crosswalk[s];else{let e=s.split(`.`).map(e=>+e);if(e.length!==3)throw Error(`Unknown target version: `+s);let l=e[0],u=e[1],p=e[2];if(l===1)for(;;){u>0&&--u,p>0&&--p;let e=``+l+`.`+u+`.`+p;if(abi_crosswalk[e]){c=abi_crosswalk[e],console.log(`Warning: node-pre-gyp could not find exact match for `+s),console.log(`Warning: but node-pre-gyp successfully choose `+e+` as ABI compatible target`);break}if(u===0&&p===0)break}else if(l>=2)major_versions[l]&&(c=abi_crosswalk[major_versions[l]],console.log(`Warning: node-pre-gyp could not find exact match for `+s),console.log(`Warning: but node-pre-gyp successfully choose `+major_versions[l]+` as ABI compatible target`));else if(l===0&&e[1]%2==0)for(;--p>0;){let e=``+l+`.`+u+`.`+p;if(abi_crosswalk[e]){c=abi_crosswalk[e],console.log(`Warning: node-pre-gyp could not find exact match for `+s),console.log(`Warning: but node-pre-gyp successfully choose `+e+` as ABI compatible target`);break}}}if(!c)throw Error(`Unsupported target version: `+s);return get_node_abi(e,{node:s,v8:c.v8+`.0`,modules:c.node_abi>1?c.node_abi:void 0})}else return get_node_abi(e,process.versions)}module.exports.get_runtime_abi=get_runtime_abi;const required_parameters=[`module_name`,`module_path`,`host`];function validate_config(e,s){let l=e.name+` package.json is not node-pre-gyp ready:
`,d=[];e.main||d.push(`main`),e.version||d.push(`version`),e.name||d.push(`name`),e.binary||d.push(`binary`);let f=e.binary;if(f&&required_parameters.forEach(e=>{(!f[e]||typeof f[e]!=`string`)&&d.push(`binary.`+e)}),d.length>=1)throw Error(l+`package.json must declare these properties: 
`+d.join(`
`));if(f){let e=url.parse(f.host).protocol;if(e===`http:`)throw Error(`'host' protocol (`+e+`) is invalid - only 'https:' is accepted`)}napi.validate_package_json(e,s)}module.exports.validate_config=validate_config;function eval_template(e,s){return Object.keys(s).forEach(c=>{let l=`{`+c+`}`;for(;e.indexOf(l)>-1;)e=e.replace(l,s[c])}),e}function fix_slashes(e){return e.slice(-1)===`/`?e:e+`/`}function drop_double_slashes(e){return e.replace(/\/\//g,`/`)}function get_process_runtime(e){let s=`node`;return e[`node-webkit`]?s=`node-webkit`:e.electron&&(s=`electron`),s}module.exports.get_process_runtime=get_process_runtime;const default_package_name=`{module_name}-v{version}-{node_abi}-{platform}-{arch}.tar.gz`,default_remote_path=``;module.exports.evaluate=function(d,f,p){f||={},validate_config(d,f);let m=d.version,h=semver.parse(m),g=f.runtime||get_process_runtime(process.versions),_={name:d.name,configuration:f.debug?`Debug`:`Release`,debug:f.debug,module_name:d.binary.module_name,version:h.version,prerelease:h.prerelease.length?h.prerelease.join(`.`):``,build:h.build.length?h.build.join(`.`):``,major:h.major,minor:h.minor,patch:h.patch,runtime:g,node_abi:get_runtime_abi(g,f.target),node_abi_napi:napi.get_napi_version(f.target)?`napi`:get_runtime_abi(g,f.target),napi_version:napi.get_napi_version(f.target),napi_build_version:p||``,node_napi_label:p?`napi-v`+p:get_runtime_abi(g,f.target),target:f.target||``,platform:f.target_platform||process.platform,target_platform:f.target_platform||process.platform,arch:f.target_arch||process.arch,target_arch:f.target_arch||process.arch,libc:f.target_libc||detect_libc.familySync()||`unknown`,module_main:d.main,toolset:f.toolset||``,bucket:d.binary.bucket,region:d.binary.region,s3ForcePathStyle:d.binary.s3ForcePathStyle||!1},v=_.module_name.replace(`-`,`_`);return _.host=fix_slashes(eval_template(process.env[`npm_config_`+v+`_binary_host_mirror`]||d.binary.host,_)),_.module_path=eval_template(d.binary.module_path,_),f.module_root?_.module_path=path.join(f.module_root,_.module_path):_.module_path=path.resolve(_.module_path),_.module=path.join(_.module_path,_.module_name+`.node`),_.remote_path=d.binary.remote_path?drop_double_slashes(fix_slashes(eval_template(d.binary.remote_path,_))):``,_.package_name=eval_template(d.binary.package_name?d.binary.package_name:`{module_name}-v{version}-{node_abi}-{platform}-{arch}.tar.gz`,_),_.staged_tarball=path.join(`build/stage`,_.remote_path,_.package_name),_.s3ForcePathStyle?_.hosted_path=url.resolve(_.host,drop_double_slashes(`${_.bucket}/${_.remote_path}`)):_.hosted_path=url.resolve(_.host,_.remote_path),_.hosted_tarball=url.resolve(_.hosted_path,_.package_name),_};